<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gesti√≥n de Pr√©stamos ‚Äî Reportes y Calendario</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Gesti√≥n de Pr√©stamos ‚Äî Reportes</h1>
            <p class="small" style="margin-top:6px;color:#64748b">Reportes mensuales, flujo proyectado y comportamiento de pagos.</p>
            <div class="stats" style="margin-top:12px">
                <div class="stat-card"><label>Total Prestado</label><div class="value" id="totalPrestado">$0</div></div>
                <div class="stat-card"><label>Total a Cobrar</label><div class="value" id="totalACobrar">$0</div></div>
                <div class="stat-card"><label>Capital Restante</label><div class="value" id="capitalRestante">$0</div></div>
                <div class="stat-card"><label>Intereses Cobrados</label><div class="value" id="interesesCobrados">$0</div></div>
                <div class="stat-card"><label>Pr√©stamos Activos</label><div class="value" id="prestamosActivos">0</div></div>
                <div class="stat-card"><label>Cuotas Vencidas</label><div class="value" id="cuotasVencidasGlobal">0</div></div>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom:10px">‚ûï Nuevo Pr√©stamo</h3>
            <div class="form-grid">
                <input id="nombre" type="text" placeholder="Nombre del prestatario">
                <input id="telefono" type="text" placeholder="Tel√©fono del prestatario">
                <input id="monto" type="number" placeholder="Monto prestado (COP)">
                <input id="tasa" type="number" step="0.01" placeholder="Tasa mensual (%)">
                <input id="cuotas" type="number" placeholder="N√∫mero de cuotas">
                <select id="tipoPrestamo" onchange="toggleCuotasInput()">
                    <option value="cuotas_fijas">Cuotas Fijas</option>
                    <option value="solo_interes">Solo Inter√©s Mensual</option>
                </select>
                <input id="fechaPrestamo" type="date">
                <input id="diaCobro" type="number" placeholder="D√≠a de cobro (1-31)" min="1" max="31">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn btn-primary" onclick="agregarPrestamo()">Agregar Pr√©stamo</button>
                <button class="btn" onclick="limpiarStorage()">Limpiar Datos</button>
            </div>
        </div>

        <div class="layout">
            <!-- Loans Section - Full Width -->
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h3 style="margin:0;color:#0f172a">Pr√©stamos</h3>
                    <div style="display:flex;gap:8px">
                        <button class="btn" onclick="renderLoans()">Ordenar / Actualizar</button>
                        <button class="btn btn-primary" onclick="exportarTodosCSV()">Exportar Todos CSV</button>
                    </div>
                </div>

                <!-- Search Container -->
                <div class="search-container">
                    <input id="searchInput" type="text" oninput="filtrarClientes()" placeholder="Buscar cliente por nombre, documento o n√∫mero de pr√©stamo...">
                    <span class="icon-search">üîç</span>
                </div>

                <div class="loans-list" id="loansContainer"></div>

                <div class="groups" style="margin-top:12px">
                    <div class="group-card"><h4>üìÖ Cobros de esta semana</h4><div class="group-list" id="groupThisWeek"></div></div>
                    <div class="group-card"><h4>üóìÔ∏è Cobros del mes actual</h4><div class="group-list" id="groupThisMonth"></div></div>
                    <div class="group-card"><h4>üìÜ Cobros del pr√≥ximo mes</h4><div class="group-list" id="groupNextMonth"></div></div>
                    <div class="group-card"><h4>üîÆ Cobros futuros</h4><div class="group-list" id="groupFuture"></div></div>
                </div>
            </div>

            <!-- Calendar + Reports Section -->
            <div>
                <div class="calendar">
                    <div class="cal-header">
                        <div class="cal-controls">
                            <button class="btn" id="prevMonth"><</button>
                            <div class="month-label" id="monthLabel">Mes A√±o</div>
                            <button class="btn" id="nextMonth">></button>
                            <button class="btn" id="todayBtn">Hoy</button>
                        </div>
                        <div class="flex-row">
                            <button class="btn btn-primary" onclick="renderCalendar(currentYear,currentMonth)">Refrescar</button>
                        </div>
                    </div>

                    <div class="cal-grid" id="weekdayHeader" style="margin-bottom:8px">
                        <div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mi√©</div>
                        <div class="weekday">Jue</div><div class="weekday">Vie</div><div class="weekday">S√°b</div><div class="weekday">Dom</div>
                    </div>

                    <div class="cal-grid" id="calendarGrid"></div>
                </div>

                <div class="reports">
                    <div class="report-card">
                        <h4>üìä Reporte mensual ‚Äî Comparativo</h4>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                            <div class="small">Mes actual:</div>
                            <select id="reportMonthSelector" onchange="renderMonthlyReport()"></select>
                            <div class="small">A√±o:</div>
                            <select id="reportYearSelector" onchange="renderMonthlyReport()"></select>
                            <button class="btn" onclick="renderMonthlyReport()">Aplicar</button>
                        </div>

                        <table class="table" style="margin-top:10px">
                            <thead>
                                <tr><th>Concepto</th><th>Mes Actual</th><th>Mes Pasado</th></tr>
                            </thead>
                            <tbody id="monthlyReportBody">
                                <tr><td>Total (Capital+Inter√©s)</td><td id="r_total_current">$0</td><td id="r_total_prev">$0</td></tr>
                                <tr><td>Solo Intereses</td><td id="r_interest_current">$0</td><td id="r_interest_prev">$0</td></tr>
                                <tr><td>Variaci√≥n %</td><td id="r_variation">0%</td><td></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="report-card">
                        <h4>üìà Flujo proyectado (12 meses)</h4>
                        <div class="small" style="margin-bottom:8px">Proyecci√≥n de ingresos (capital + inter√©s) por mes seg√∫n cuotas programadas.</div>
                        <div class="mountain" id="projectedMountain"></div>
                        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:#475569" id="projLabels"></div>
                    </div>

                    <div class="report-card" style="grid-column:1/ -1">
                        <h4>üìä Intereses cobrados por mes (hist√≥rico)</h4>
                        <table class="table" id="interestsTable">
                            <thead><tr><th>Mes</th><th>Intereses cobrados (pagados)</th></tr></thead>
                            <tbody id="interestsBody"></tbody>
                        </table>
                    </div>

                    <div class="report-card">
                        <h4>üë• Historial de pagos ‚Äî Comportamiento</h4>
                        <div class="small" style="margin-bottom:8px">Lista r√°pida: % a tiempo ‚Äî clientes que pagan bien vs. los que atrasan.</div>
                        <div class="client-list" id="clientHistoryList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3>Pagar Cuota con Excedente (Modificaci√≥n Autom√°tica)</h3>
                <div class="form-group">
                    <label>Cliente:</label>
                    <input id="modalClientName" type="text" readonly>
                </div>
                <div class="form-group">
                    <label>Cuota #:</label>
                    <input id="modalCuotaNumber" type="text" readonly>
                </div>
                <div class="form-group">
                    <label>Valor Cuota:</label>
                    <input id="modalCuotaValue" type="text" readonly>
                </div>
                <div class="form-group">
                    <label>Pago Recibido:</label>
                    <input id="modalPagoRecibido" type="number" placeholder="Ingrese el monto recibido">
                </div>
                <div class="form-group">
                    <label>Modo de Rec√°lculo:</label>
                    <select id="modalRecalculoMode">
                        <option value="A">A - Reducir valor cuotas (mantener n√∫mero)</option>
                        <option value="B">B - Reducir n√∫mero cuotas (mantener valor)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Excedente:</label>
                    <input id="modalExcedente" type="text" readonly style="background:#f3f4f6;color:#6b7280">
                </div>
                <div class="form-group">
                    <label>Efecto en cuotas futuras:</label>
                    <div style="background:#f3f4f6;color:#6b7280;padding:8px;border-radius:6px;font-size:12px;margin-bottom:10px;">
                        El excedente se aplicar√° autom√°ticamente al capital pendiente y modificar√° las cuotas futuras seg√∫n el modo seleccionado.
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-cancel" onclick="cerrarModalPago()">Cancelar</button>
                    <button class="btn btn-primary" onclick="confirmarPagoExcedente()">Confirmar Pago</button>
                </div>
            </div>
        </div>

        <!-- Date Edit Modal -->
        <div id="dateEditModal" class="modal" style="display:none;">
            <div class="modal-content">
                <h3 id="dateEditTitle">Editar Fecha</h3>
                <div class="form-group">
                    <label id="dateEditLabel">Nueva fecha:</label>
                    <input id="dateEditInput" type="date">
                </div>
                <div class="form-group">
                    <label>Recalcular cuotas autom√°ticamente:</label>
                    <input type="checkbox" id="recalcularCuotas" checked>
                    <small style="display:block;color:#6b7280;margin-top:4px">Si est√° activado, se recalcular√°n todas las fechas de cobro basadas en la nueva fecha de pr√©stamo</small>
                </div>
                <div class="button-group">
                    <button class="btn btn-cancel" onclick="cerrarModalEdicionFecha()">Cancelar</button>
                    <button class="btn btn-primary" onclick="confirmarEdicionFecha()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Viewer Modal -->
    <div id="receiptViewerModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 800px;">
            <h3>Comprobante de Pago</h3>
            <div style="text-align:center;margin:20px 0">
                <img id="receiptViewerImage" src="" style="max-width:100%;max-height:60vh;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
            </div>
            <div class="button-group">
                <button class="btn btn-cancel" onclick="closeReceiptViewer()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <!-- Order matters: utils.js first (contains global variables), main.js last (initialization) -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/loans.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/payments.js"></script>
    <script src="js/ui.js"></script>
    <script src="add_test_data.js"></script>
    <script src="js/main.js"></script>
</body>
</html>

